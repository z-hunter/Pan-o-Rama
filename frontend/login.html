<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login - Pan-o-Rama</title>
  <style>
    body { font-family: Segoe UI, sans-serif; margin: 0; background: #111; color: #eee; }
    .wrap { max-width: 480px; margin: 60px auto; background: #1b1b1b; border: 1px solid #333; border-radius: 10px; padding: 24px; }
    h1 { margin-top: 0; font-size: 22px; }
    .row { margin-bottom: 12px; }
    input { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #444; background: #222; color: #eee; box-sizing: border-box; }
    button { width: 100%; padding: 10px; border: 0; border-radius: 6px; background: #007bff; color: #fff; font-weight: 700; cursor: pointer; }
    .alt { margin-top: 10px; background: #333; }
    .msg { margin-top: 12px; color: #9ecbff; min-height: 18px; }
    a { color: #89c2ff; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Pan-o-Rama Account</h1>
    <div class="row"><input id="email" type="email" placeholder="Email" /></div>
    <div class="row"><input id="password" type="password" placeholder="Password (min 8)" /></div>
    <div class="row"><input id="displayName" type="text" placeholder="Display name (for register)" /></div>
    <button onclick="login()">Login</button>
    <button class="alt" onclick="register()">Register</button>
    <button class="alt" onclick="resendVerification()">Resend verification email</button>
    <p class="msg" id="msg"></p>
    <p><a href="/">Back to editor</a></p>
  </div>
<script>
async function login() {
  await auth('/auth/login', { email: email.value.trim(), password: password.value });
}
async function register() {
  msg.textContent = '';
  const payload = {
    email: email.value.trim(),
    password: password.value,
    display_name: displayName.value.trim()
  };
  const res = await fetch('/auth/register', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const data = await res.json().catch(() => ({}));
  if (!res.ok) {
    msg.textContent = data.error || 'Register failed';
    return;
  }
  if (data.user) {
    window.location.href = '/dashboard';
    return;
  }
  msg.textContent = 'Registration successful. Please check your email and confirm your account.';
}

async function resendVerification() {
  msg.textContent = '';
  const e = email.value.trim();
  if (!e) {
    msg.textContent = 'Enter your email first.';
    return;
  }
  const res = await fetch('/auth/verification/resend', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email: e })
  });
  const data = await res.json().catch(() => ({}));
  if (!res.ok) {
    msg.textContent = data.error || 'Failed to resend verification email';
    return;
  }
  msg.textContent = data.message || 'Verification email sent';
}
async function auth(url, payload) {
  msg.textContent = '';
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const data = await res.json().catch(() => ({}));
  if (!res.ok) {
    if (data.code === 'email_not_verified') {
      msg.textContent = 'Please verify your email first. Use "Resend verification email" if needed.';
      return;
    }
    msg.textContent = data.error || 'Request failed';
    return;
  }
  window.location.href = '/dashboard';
}

(function initLoginHints() {
  const p = new URLSearchParams(window.location.search);
  const verified = p.get('verified');
  const reason = p.get('reason');
  if (verified === '1') {
    msg.textContent = 'Email confirmed. You can now log in.';
    return;
  }
  if (verified === '0') {
    if (reason === 'expired') msg.textContent = 'Verification link expired. Request a new email.';
    else msg.textContent = 'Invalid verification link. Request a new email.';
  }
})();
</script>
</body>
</html>
