<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pan-o-Rama Pro - Studio</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #1a1a1a; color: #eee; height: 100vh; display: flex; flex-direction: column; }
        .app-header { background: #2a2a2a; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #444; }
        .logo-small { height: 40px; }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 300px; background: #222; border-right: 1px solid #444; padding: 20px; display: flex; flex-direction: column; gap: 20px; height: 100%; box-sizing: border-box; }
        .viewer-container { flex: 1; position: relative; background: #000; height: 100%; }
        #pano-editor { width: 100%; height: 100%; }
        .step { display: none; }
        .step.active { display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0; }
        .btn { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; text-align: center; text-decoration: none; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-ghost { background: transparent; border: 1px solid #555; color: #ccc; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .scene-item { background: #333; padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; cursor: pointer; border: 2px solid transparent; }
        .scene-item.active { border-color: #007bff; background: #3d3d3d; }
        input, select { padding: 10px; border-radius: 4px; border: 1px solid #444; background: #333; color: white; width: 100%; box-sizing: border-box; }
        .hud { position: absolute; top: 20px; right: 20px; z-index: 100; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 8px; pointer-events: none; }
        .hud.interactive { pointer-events: auto; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; flex-direction: column; }
        
        /* Portal Styles (shared with viewer) */
        .custom-hotspot { 
            height: 30px; width: 30px; 
            background: rgba(0, 123, 255, 0.4); 
            border: 2px solid #fff; 
            border-radius: 50%; 
            cursor: pointer; 
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
        }
        .custom-hotspot::after {
            content: ''; width: 8px; height: 8px;
            border-top: 3px solid #fff; border-right: 3px solid #fff;
            transform: rotate(-45deg) translate(-1px, 1px);
        }

        /* Center Logo for Step 1 */
        .center-logo-container { padding: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .logo-giant { max-height: 400px; width: auto; filter: drop-shadow(0 0 20px rgba(0,123,255,0.2)); margin-bottom: 30px; animation: pulse 4s infinite ease-in-out; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.9; } 50% { transform: scale(1.02); opacity: 1; } 100% { transform: scale(1); opacity: 0.9; } }
    </style>
</head>
<body>
    <div class="app-header">
        <div style="display:flex; align-items:center; gap:15px;">
            <img src="/img/logo.png" class="logo-small" alt="Logo">
            <h2 style="margin:0; color:#007bff;">Pan-o-Rama Pro Studio</h2>
        </div>
        <a href="/all-projects" class="btn btn-ghost">All Projects</a>
    </div>

    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div id="project-scenes" style="display:none; flex-direction: column; flex: 1; min-height: 0;">
                <h3>Scenes & Rooms</h3>
                <div id="scenesList" style="flex:1; overflow-y:auto; margin-bottom: 15px;"></div>
                <hr style="border-color:#444; margin:15px 0;">
                
                <!-- Step 2 content: Add Room -->
                <div id="step2" class="step">
                    <h4>Add Room</h4>
                    <input type="text" id="sceneName" placeholder="e.g. Lobby">
                    <input type="file" id="sceneFiles" multiple accept="image/*" style="margin-top:10px;">
                    <button class="btn btn-success" style="margin-top:10px; width:100%;" id="addBtn" onclick="addScene()">Process Room</button>
                    <button class="btn btn-primary" id="gotoStep3" style="display:none; margin-top:15px;" onclick="startLinking()">Link Rooms &rarr;</button>
                </div>

                <!-- Step 3 content: Linking -->
                <div id="step3" class="step">
                    <h3>Linking Lab</h3>
                    <p>Click on the panorama to place a portal.</p>
                    <div id="linkingStatus" style="font-size:0.9em; color:#aaa; margin-bottom:15px;">Selected: None</div>
                    
                    <div id="portalForm" style="display:none; background:#333; padding:15px; border-radius:8px;">
                        <label>Leads to:</label>
                        <select id="targetScene" style="margin-bottom:10px;"></select>
                        <button class="btn btn-primary" style="width:100%;" onclick="savePortal()">Save Portal</button>
                    </div>

                    <div style="margin-top:auto;">
                        <button class="btn btn-success" style="width:100%;" onclick="finalizeTour()">Finish & Publish</button>
                        <button class="btn btn-ghost" style="width:100%; margin-top:10px;" onclick="showStep(2)">Add More Rooms</button>
                    </div>
                </div>
            </div>

            <!-- Step 1: Init -->
            <div id="step1" class="step active">
                <h3>New Project</h3>
                <p>Start a professional virtual tour.</p>
                <button class="btn btn-primary" onclick="createProject()">Initialize Studio &rarr;</button>
            </div>
        </div>

        <!-- Viewer / Workspace -->
        <div class="viewer-container">
            <div id="step1-workspace" class="step active">
                <div class="center-logo-container">
                    <img src="/img/logo.png" class="logo-giant" alt="Pan-o-Rama Logo large">
                    <h1 style="font-size: 3em; color: #007bff; text-shadow: 0 0 10px rgba(0,0,0,0.5);">PAN-O-RAMA PRO</h1>
                    <p style="font-size: 1.2em; color: #888;">The Ultimate Virtual Tour Experience</p>
                </div>
            </div>
            <div id="pano-editor" style="display:none; width:100%; height:100%;"></div>
            <div class="hud" id="editorHud" style="display:none;">
                <div id="coords">Pitch: 0 | Yaw: 0</div>
                <div style="color:#007bff; font-weight:bold; margin-top:5px;">EDITOR MODE ACTIVE</div>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loader">
        <div style="font-size:2em; margin-bottom:10px;">‚öôÔ∏è</div>
        <div id="loaderText">Processing Assets...</div>
    </div>

    <script>
        let projectId = null;
        let scenes = [];
        let activeSceneId = null;
        let viewer = null;
        let lastClickCoords = null;

        async function createProject() {
            setLoading(true, "Initializing...");
            try {
                const res = await fetch('/api/project/create', { method: 'POST' });
                const data = await res.json();
                projectId = data.project_id;
                showStep(2);
            } finally { setLoading(false); }
        }

        async function addScene() {
            const name = document.getElementById('sceneName').value;
            const files = document.getElementById('sceneFiles').files;
            if (!name || files.length === 0) return alert("Fill all fields");

            const formData = new FormData();
            formData.append('scene_name', name);
            formData.append('is_panorama', 'true');
            for(let f of files) formData.append('files[]', f);

            setLoading(true, "Stitching Panorama...");
            try {
                const res = await fetch(`/api/project/${projectId}/scene/add`, { method: 'POST', body: formData });
                const data = await res.json();
                scenes.push(data.scene);
                updateScenesUI();
                document.getElementById('gotoStep3').style.display = 'block';
                document.getElementById('sceneName').value = '';
                document.getElementById('sceneFiles').value = '';
                if (!activeSceneId) loadScene(data.scene.id);
            } finally { setLoading(false); }
        }

        function updateScenesUI() {
            const list = document.getElementById('scenesList');
            if (!list) return;
            list.innerHTML = '';
            scenes.forEach(s => {
                const div = document.createElement('div');
                div.className = 'scene-item' + (activeSceneId === s.id ? ' active' : '');
                div.innerHTML = `<span>üè† ${s.name}</span>`;
                div.onclick = () => loadScene(s.id);
                list.appendChild(div);
            });
        }

        function loadScene(id, targetPitch = null, targetYaw = null) {
            console.log("Loading scene:", id);
            const scene = scenes.find(s => s.id === id);
            if (!scene) return;

            const url = `/galleries/${projectId}/${id}/${scene.panorama || scene.images[0]}`;
            
            const config = {
                "type": "equirectangular",
                "panorama": url,
                "autoLoad": true,
                "sceneFadeDuration": 1000,
                "hotSpots": scene.hotspots.map(h => ({
                    pitch: h.pitch, yaw: h.yaw, 
                    cssClass: "custom-hotspot",
                    createTooltipFunc: hotspotTooltip,
                    createTooltipArgs: "Go to " + h.target_name,
                    clickHandlerFunc: () => transitionToScene(h.target_id, h.pitch, h.yaw)
                }))
            };

            if (viewer) {
                // If we have a target pitch/yaw, it means we are coming from a portal
                if (targetPitch !== null && targetYaw !== null) {
                    const currentHfov = viewer.getHfov();
                    viewer.setHfov(currentHfov - 40, 800);
                    viewer.lookAt(targetPitch, targetYaw, currentHfov - 40, 800, () => {
                        viewer.destroy();
                        viewer = pannellum.viewer('pano-editor', config);
                        activeSceneId = id;
                        updateScenesUI();
                    });
                    return;
                }
                viewer.destroy();
            }
            
            viewer = pannellum.viewer('pano-editor', config);
            activeSceneId = id;
            updateScenesUI();
            
            document.getElementById('step1-workspace').style.display = 'none';
            document.getElementById('pano-editor').style.display = 'block';

            viewer.on('mousedown', (e) => {
                if (document.getElementById('step3').classList.contains('active')) {
                    const coords = viewer.mouseEventToCoords(e);
                    lastClickCoords = coords;
                    console.log("Portal target location selected:", coords);
                    document.getElementById('linkingStatus').innerHTML = `<strong>Selected:</strong> Pitch: ${coords[0].toFixed(1)}, Yaw: ${coords[1].toFixed(1)}`;
                    document.getElementById('portalForm').style.display = 'block';
                    
                    const select = document.getElementById('targetScene');
                    select.innerHTML = '<option value="">Select Destination...</option>';
                    scenes.filter(s => s.id !== activeSceneId).forEach(s => {
                        select.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                    });
                }
            });
        }

        function transitionToScene(targetId, pitch, yaw) {
            loadScene(targetId, pitch, yaw);
        }

        function hotspotTooltip(hotSpotDiv, args) {
            hotSpotDiv.classList.add('custom-hotspot');
            const span = document.createElement('span');
            span.innerHTML = args;
            span.style.cssText = "visibility: hidden; background: rgba(0,0,0,0.8); color: #fff; border-radius: 4px; padding: 5px; position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); white-space: nowrap;";
            hotSpotDiv.appendChild(span);
            hotSpotDiv.onmouseover = () => span.style.visibility = 'visible';
            hotSpotDiv.onmouseout = () => span.style.visibility = 'hidden';
        }

        function startLinking() {
            if (!activeSceneId && scenes.length > 0) loadScene(scenes[0].id);
            showStep(3);
            document.getElementById('editorHud').style.display = 'block';
        }

        function savePortal() {
            const targetId = document.getElementById('targetScene').value;
            if (!targetId) return;
            
            const targetScene = scenes.find(s => s.id === targetId);
            const scene = scenes.find(s => s.id === activeSceneId);
            
            scene.hotspots.push({
                pitch: lastClickCoords[0],
                yaw: lastClickCoords[1],
                target_id: targetId,
                target_name: targetScene.name
            });

            viewer.addHotSpot({
                pitch: lastClickCoords[0],
                yaw: lastClickCoords[1],
                cssClass: "custom-hotspot",
                createTooltipFunc: hotspotTooltip,
                createTooltipArgs: "Go to " + targetScene.name,
                clickHandlerFunc: () => transitionToScene(targetId, lastClickCoords[0], lastClickCoords[1])
            });

            document.getElementById('portalForm').style.display = 'none';
            document.getElementById('linkingStatus').textContent = 'Portal added! Click again to add more.';
        }

        async function finalizeTour() {
            setLoading(true, "Finalizing Tour...");
            // Save all hotspots
            const hotspotData = {};
            scenes.forEach(s => hotspotData[s.id] = s.hotspots);

            try {
                await fetch(`/api/project/${projectId}/hotspots`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(hotspotData)
                });

                const res = await fetch(`/api/project/${projectId}/finalize`, { method: 'POST' });
                const data = await res.json();
                window.open(data.gallery_url, '_blank');
            } finally { setLoading(false); }
        }

        function showStep(n) {
            // Hide all steps
            document.querySelectorAll('.sidebar .step').forEach(s => s.classList.remove('active'));
            
            // Show requested step
            const target = document.getElementById('step' + n);
            if (target) target.classList.add('active');

            // Manage project container
            const projectScenes = document.getElementById('project-scenes');
            if (n > 1) {
                projectScenes.style.display = 'flex';
            } else {
                projectScenes.style.display = 'none';
            }
        }

        function setLoading(show, text = "") {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
            document.getElementById('loaderText').textContent = text;
        }
    </script>
</body>
</html>
