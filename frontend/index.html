<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pan-o-Rama - Step-by-Step Creator</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background-color: #1a1a1a; color: #eee; }
        .container { background-color: #2a2a2a; padding: 30px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); max-width: 800px; margin: 0 auto; }
        .header { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; margin-bottom: 30px; }
        .logo { max-height: 80px; transition: 0.5s ease; }
        .logo-large { max-height: 250px; margin-bottom: 20px; }
        h1 { color: #007bff; margin: 0; font-size: 2.5em; }
        .step { display: none; text-align: center; }
        .step.active { display: block; }
        .step-left { text-align: left; }
        .scene-item { background: #333; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        input, select { padding: 10px; border-radius: 4px; border: 1px solid #444; background: #333; color: white; width: 100%; box-sizing: border-box; margin-bottom: 15px; }
        .progress-bar { height: 10px; background: #444; border-radius: 5px; margin: 20px 0; overflow: hidden; display: none; }
        .progress-inner { height: 100%; background: #007bff; width: 0%; transition: 0.3s; }
        .nav-links { text-align: right; margin-bottom: 20px; }
        .nav-links a { color: #007bff; text-decoration: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-links"><a href="/all-projects">View All Projects &rarr;</a></div>
        <div class="header">
            <img src="/img/logo.png" alt="Pan-o-Rama Logo" class="logo" onerror="this.style.display='none'">
            <h1>Pan-o-Rama</h1>
        </div>

        <!-- Step 1: Create Project -->
        <div id="step1" class="step active">
            <h2>Step 1: Start New Project</h2>
            <p>Give your virtual tour a starting point.</p>
            <button class="btn btn-primary" onclick="createProject()">Create Project &rarr;</button>
        </div>

        <!-- Step 2: Add Scenes -->
        <div id="step2" class="step step-left">
            <h2>Step 2: Add Rooms / Scenes</h2>
            <div id="scenesList"></div>
            <hr style="border-color: #444;">
            <h3>Add New Scene</h3>
            <label>Room Name:</label>
            <input type="text" id="sceneName" placeholder="e.g. Living Room">
            <label>Images (Select multiple for panorama):</label>
            <input type="file" id="sceneFiles" multiple accept="image/*">
            <div style="margin-bottom: 15px;">
                <input type="checkbox" id="isPano" checked style="width: auto;"> <label for="isPano">Stitch into Panorama</label>
            </div>
            <button class="btn btn-success" id="addSceneBtn" onclick="addScene()">Process and Add Scene</button>
            <div class="progress-bar" id="progressBar"><div class="progress-inner" id="progressInner"></div></div>
            <p id="statusMsg" style="font-style: italic; color: #aaa;"></p>
            <hr style="border-color: #444;">
            <button class="btn btn-primary" id="finalizeBtn" style="width: 100%; display: none;" onclick="finalizeTour()">Generate Final Virtual Tour &rarr;</button>
        </div>

        <!-- Step 3: Success -->
        <div id="step3" class="step">
            <h2>Success!</h2>
            <p>Your virtual tour is ready.</p>
            <div id="finalLink"></div>
            <br>
            <button class="btn btn-secondary" onclick="location.reload()">Create Another</button>
        </div>
    </div>

    <script>
        let currentProjectId = null;
        let scenesCount = 0;

        async function createProject() {
            try {
                const res = await fetch('/api/project/create', { method: 'POST' });
                const data = await res.json();
                currentProjectId = data.project_id;
                showStep(2);
            } catch (e) { alert("Error: " + e.message); }
        }

        async function addScene() {
            const name = document.getElementById('sceneName').value;
            const files = document.getElementById('sceneFiles').files;
            const isPano = document.getElementById('isPano').checked;

            if (!name || files.length === 0) {
                alert("Please provide a name and at least one image.");
                return;
            }

            const formData = new FormData();
            formData.append('scene_name', name);
            formData.append('is_panorama', isPano);
            for (let f of files) formData.append('files[]', f);

            const btn = document.getElementById('addSceneBtn');
            const progress = document.getElementById('progressBar');
            const inner = document.getElementById('progressInner');
            const status = document.getElementById('statusMsg');

            btn.disabled = true;
            progress.style.display = 'block';
            inner.style.width = '50%';
            status.textContent = "Uploading and processing... This may take a minute.";

            try {
                const res = await fetch(`/api/project/${currentProjectId}/scene/add`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                
                if (res.ok) {
                    scenesCount++;
                    addSceneToUI(name);
                    document.getElementById('sceneName').value = '';
                    document.getElementById('sceneFiles').value = '';
                    document.getElementById('finalizeBtn').style.display = 'block';
                    status.textContent = "Scene added successfully!";
                } else {
                    alert("Error: " + data.error);
                }
            } catch (e) { alert("Connection error: " + e.message); }
            finally {
                btn.disabled = false;
                inner.style.width = '100%';
                setTimeout(() => { progress.style.display = 'none'; inner.style.width = '0%'; }, 1000);
            }
        }

        function addSceneToUI(name) {
            const list = document.getElementById('scenesList');
            const div = document.createElement('div');
            div.className = 'scene-item';
            div.innerHTML = `<span>üè† ${name}</span> <span style="color:#28a745">Ready</span>`;
            list.appendChild(div);
        }

        async function finalizeTour() {
            try {
                const res = await fetch(`/api/project/${currentProjectId}/finalize`, { method: 'POST' });
                const data = await res.json();
                document.getElementById('finalLink').innerHTML = `<a href="${data.gallery_url}" target="_blank" class="btn btn-success" style="text-decoration:none; display:inline-block;">Open Virtual Tour</a>`;
                showStep(3);
            } catch (e) { alert("Error: " + e.message); }
        }

        function showStep(n) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + n).classList.add('active');
            
            const logo = document.querySelector('.logo');
            if (n === 1) {
                logo.classList.add('logo-large');
            } else {
                logo.classList.remove('logo-large');
            }
        }

        // Initialize
        showStep(1);
    </script>
</body>
</html>
