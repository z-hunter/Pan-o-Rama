<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Pan-o-Rama</title>
  <style>
    body { font-family: Segoe UI, sans-serif; margin: 0; background: #f1f4f8; color: #222; }
    .top { background: #fff; border-bottom: 1px solid #d9e2ef; padding: 12px 18px; display: flex; justify-content: space-between; align-items: center; }
    .wrap { max-width: 1000px; margin: 20px auto; padding: 0 16px; }
    .card { background: #fff; border: 1px solid #d9e2ef; border-radius: 10px; padding: 16px; margin-bottom: 18px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 14px; }
    .tour { background: #fff; border: 1px solid #d9e2ef; border-radius: 10px; padding: 12px; }
    input, select, textarea { width: 100%; box-sizing: border-box; padding: 8px; margin-top: 6px; }
    button { padding: 9px 12px; border: 0; border-radius: 6px; background: #007bff; color: #fff; cursor: pointer; }
    .muted { color: #667; font-size: 13px; }
    .row { margin-bottom: 10px; }
    .danger { background: #c53d3d; }
    .plan { background: #f8fbff; border: 1px solid #d9e2ef; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
    .meter { height: 8px; background: #e6edf5; border-radius: 999px; overflow: hidden; margin-top: 6px; }
    .meter > div { height: 100%; background: #2b7de9; }
    .upgrade { background: #1e57a8; }
    .pill { display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; background:#eef3f8; border:1px solid #d9e2ef; margin-left:6px; }
    .access-box { margin-top:10px; padding:10px; border:1px dashed #ccd7e5; border-radius:8px; background:#fafcff; }
    .access-row { display:flex; gap:8px; align-items:center; margin-top:6px; }
    .access-row input { margin-top:0; }
    .access-list { margin-top:8px; display:flex; flex-direction:column; gap:6px; }
    .access-item { display:flex; align-items:center; justify-content:space-between; gap:8px; background:#fff; border:1px solid #e5ebf4; border-radius:8px; padding:6px 8px; }
    .mini { padding:6px 8px; font-size:12px; }
  </style>
</head>
<body>
  <div class="top">
    <strong>Pan-o-Rama Dashboard</strong>
    <div>
      <a href="/account">Account</a>
      <button style="margin-left:10px" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="wrap">
    <div class="plan">
      <div><strong id="planName">-</strong></div>
      <div class="muted" id="planUsage">-</div>
      <div class="meter"><div id="planBar" style="width:0%"></div></div>
      <div style="margin-top:8px">
        <button class="upgrade" onclick="location.href='/account'">Upgrade plan</button>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Create Tour</h3>
      <div class="row"><input id="title" placeholder="Tour title" /></div>
      <div class="row"><textarea id="description" placeholder="Description"></textarea></div>
      <div class="row">
        <select id="visibility">
          <option value="public">Public</option>
          <option value="private">Private (owner only)</option>
        </select>
      </div>
      <button onclick="createTour()">Create</button>
      <p id="createMsg" class="muted"></p>
    </div>

    <h3>My Tours</h3>
    <div id="tours" class="grid"></div>
  </div>

<script>
let currentPlanId = null;

async function api(url, opts = {}) {
  const res = await fetch(url, opts);
  const data = await res.json().catch(() => ({}));
  if (res.status === 401) {
    location.href = '/login';
    return null;
  }
  return { res, data };
}

async function loadMe() {
  const out = await api('/me');
  if (!out) return;
  if (!out.res.ok) return;
  const plan = out.data.plan || {};
  const usage = out.data.usage || {};
  const ent = out.data.entitlements || {};
  const tours = usage.tours_count || 0;
  const maxTours = ent.max_tours || 0;
  const ratio = maxTours > 0 ? Math.min(100, Math.round((tours / maxTours) * 100)) : 0;
  planName.textContent = `${plan.name || 'Free'} plan`;
  planUsage.textContent = `Tours: ${tours} / ${maxTours} | Remaining: ${ent.remaining_tours ?? 0}`;
  planBar.style.width = `${ratio}%`;
  currentPlanId = (plan.id || '').toLowerCase();
  const privateOpt = document.querySelector('#visibility option[value="private"]');
  if (privateOpt) {
    const free = currentPlanId === 'free';
    privateOpt.disabled = free;
    privateOpt.textContent = free ? 'Private (paid plan required)' : 'Private (author + allowed users)';
    if (free && visibility.value === 'private') visibility.value = 'public';
  }
}

async function loadTours() {
  const out = await api('/tours/my');
  if (!out) return;
  const list = out.data.tours || [];
  tours.innerHTML = '';
  for (const t of list) {
    const el = document.createElement('div');
    el.className = 'tour';
    const visibilityPill = t.visibility === 'private' ? '<span class="pill">private</span>' : '<span class="pill">public</span>';
    el.innerHTML = `
      <h4 style="margin:0 0 6px">${t.title}</h4>
      <div class="muted">${visibilityPill} ${t.status}</div>
      <div class="muted">slug: ${t.slug}</div>
      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
        <button onclick="openStudio('${t.id}')">Open Studio</button>
        <button onclick="openShare('${t.slug}')">Open share</button>
        <button onclick="finalize('${t.id}')">Finalize</button>
        <button class="danger" onclick="removeTour('${t.id}')">Delete</button>
      </div>
      ${t.visibility === 'private' ? `
      <div class="access-box">
        <div class="muted">Access list (users who can open this private tour)</div>
        <div class="access-row">
          <input id="accessEmail-${t.id}" placeholder="user@email.com" />
          <button class="mini" onclick="grantAccess('${t.id}')">Add</button>
        </div>
        <div id="accessList-${t.id}" class="access-list"></div>
      </div>` : ''}
    `;
    tours.appendChild(el);
    if (t.visibility === 'private') {
      loadAccessList(t.id);
    }
  }
}

async function createTour() {
  const payload = {
    title: title.value.trim(),
    description: description.value.trim(),
    visibility: visibility.value
  };
  const out = await api('/tours', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  if (!out) return;
  if (!out.res.ok && out.data && out.data.code === 'private_requires_paid_plan') {
    createMsg.innerHTML = `Private tours require paid plan. <a href="/account">Upgrade in Account</a>`;
    return;
  }
  if (!out.res.ok && out.data && out.data.code === 'plan_limit_exceeded') {
    createMsg.innerHTML = `Plan limit reached. <a href="/account">Upgrade in Account</a>`;
  } else {
    createMsg.textContent = out.res.ok ? 'Tour created' : (out.data.error || 'Failed');
  }
  if (out.res.ok) {
    title.value = '';
    description.value = '';
    await loadMe();
    await loadTours();
  }
}

function renderAccessList(tourId, items) {
  const box = document.getElementById(`accessList-${tourId}`);
  if (!box) return;
  const list = Array.isArray(items) ? items : [];
  if (!list.length) {
    box.innerHTML = `<div class="muted">No additional users added yet.</div>`;
    return;
  }
  box.innerHTML = list.map(x => `
    <div class="access-item">
      <div>
        <strong>${x.display_name || 'User'}</strong>
        <div class="muted">${x.email}</div>
      </div>
      <button class="danger mini" onclick="revokeAccess('${tourId}','${x.user_id}')">Remove</button>
    </div>
  `).join('');
}

async function loadAccessList(tourId) {
  const out = await api(`/tours/${tourId}/access`);
  if (!out || !out.res.ok) return;
  renderAccessList(tourId, out.data.items || []);
}

async function grantAccess(tourId) {
  const input = document.getElementById(`accessEmail-${tourId}`);
  if (!input) return;
  const email = input.value.trim().toLowerCase();
  if (!email) return;
  const out = await api(`/tours/${tourId}/access`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email })
  });
  if (!out) return;
  if (!out.res.ok) {
    alert(out.data.error || 'Failed to grant access');
    return;
  }
  input.value = '';
  renderAccessList(tourId, out.data.items || []);
}

async function revokeAccess(tourId, userId) {
  const out = await api(`/tours/${tourId}/access/${userId}`, { method: 'DELETE' });
  if (!out) return;
  if (!out.res.ok) {
    alert(out.data.error || 'Failed to revoke access');
    return;
  }
  renderAccessList(tourId, out.data.items || []);
}

async function finalize(id) {
  const out = await api(`/tours/${id}/finalize`, { method: 'POST' });
  if (!out) return;
  alert(out.res.ok ? `Share URL: ${out.data.share_url}` : (out.data.error || 'Finalize failed'));
  if (out.res.ok) await loadTours();
}

function openShare(slug) {
  window.open(`/t/${slug}`, '_blank');
}

function openStudio(id) {
  window.location.href = `/?tour_id=${encodeURIComponent(id)}`;
}

async function removeTour(id) {
  const out = await api(`/tours/${id}`, { method: 'DELETE' });
  if (!out) return;
  if (!out.res.ok) alert(out.data.error || 'Delete failed');
  await loadTours();
}

async function logout() {
  await api('/auth/logout', { method: 'POST' });
  location.href = '/login';
}

loadMe();
loadTours();
</script>
</body>
</html>
